---
title: "Step I. Feature Extraction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
)
options(width=100)
```

In step I, we use the `petler.fpca` function to perform a functional PCA ([Wu et al. 2013](https://doi.org/10.5705/ss.2010.162)), which is used to estimate the mean density functions (and covariance functions) using longitudinal encounter data. 

```{r lib}
library(PETLER)
```

```{r fpca, eval=FALSE}
system.time(obj <- petler.fpca(data_org))
##    user  system elapsed 
## 142.076  18.887  75.564
saveRDS(obj, "step1.rds") # save results for step II
```

```{r, echo=FALSE}
obj <- readRDS("step1.rds")
```

```{r, echo=FALSE}
TrainCode <- data_org$TrainCode
TrainCode[, monthstd := month / fu_time]  
DF.t <- rbind(
  data.frame(code = "pred1", t = with(TrainCode, rep(monthstd, pred1))),
  data.frame(code = "pred2", t = with(TrainCode, rep(monthstd, pred2))),
  data.frame(code = "pred3", t = with(TrainCode, rep(monthstd, pred3))))
DF.d <- rbind(
  cbind(code = "pred1", obj$FPCA$pred1$mean),
  cbind(code = "pred2", obj$FPCA$pred2$mean),
  cbind(code = "pred3", obj$FPCA$pred3$mean))
```

## Estimated Mean Density

```{r, fig.width=9, fig.height=3, echo=FALSE}
library(ggplot2)
ggplot(DF.t, aes(x = t)) + 
  geom_histogram(aes(y = ..density..), color="gray", fill="lightblue", binwidth = 0.01) + 
  geom_line(aes(x = x, y = f_mu), data = DF.d, colour = "blue") + 
  facet_wrap(~ code, ncol = 3, scales = "free_y") + 
  xlab("x") + theme_bw()
```

```{r, echo=FALSE}
dens1 <- obj$FPCA[[1]]$ValidPred$densities
dens2 <- obj$FPCA[[2]]$ValidPred$densities
dens3 <- obj$FPCA[[3]]$ValidPred$densities
all <- base::intersect(
  base::intersect(
    colnames(dens1)[-1], 
    colnames(dens2)[-1]), 
  colnames(dens3)[-1])
```

```{r, echo=FALSE}
f <- function(k) {
  ValidCode <- data_org$ValidCode
  ValidCode[, monthstd := month / fu_time]  
  DF.t <- rbind(
    data.frame(code = "pred1", t = with(ValidCode[id == all[k], ], rep(monthstd, pred1))),
    data.frame(code = "pred2", t = with(ValidCode[id == all[k], ], rep(monthstd, pred2))),
    data.frame(code = "pred3", t = with(ValidCode[id == all[k], ], rep(monthstd, pred3))))
  DF.d <- rbind(
    data.frame(code = "pred1", x = dens1[, 1], y = dens1[, all[k]]),
    data.frame(code = "pred2", x = dens2[, 1], y = dens2[, all[k]]),
    data.frame(code = "pred3", x = dens3[, 1], y = dens3[, all[k]]))  
  ggplot(DF.t, aes(x = t)) + 
    geom_histogram(aes(y = ..density..), color="gray", fill="lightblue", binwidth = 0.1) + 
    geom_line(aes(x = x, y = y), data = DF.d, colour = "blue") + 
    facet_wrap(~ code, ncol = 3, scales = "free_y") + 
    xlab("x") + ggtitle(paste("ID:", all[k])) + theme_bw()
}
```

## Subject-Specific Densities

The estimated mean density functions (and covariance functions) from FPCA are then used to obtain subject-specific densities, from which features will be extracted. I

```{r, fig.width=9, fig.height=3, echo=FALSE}
f(1)
f(2)
f(3)
```

## Feature Extraction

Important features from subject-specific densities and FPCA may include:

- first code time (1stCode)

- peak time (Pk)

- change point time (ChP)

- first functional PC score (1stScore)

- log of total number of codes (logN) 

The extracted features are saved in `step1.rds` and will be used in step II of the PETLER algorithm.
