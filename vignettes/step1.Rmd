---
title: "Step I: Functional PCA"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
)
options(width=100)
```

```{r lib}
library(PETLER)
```

We can use the `petler.fpca` function to create the base functions required to run the PETLER algorithm. By default, you only need to provide data in the list format mentioned above. However, you can view the help documentation (`?petler.fpca`) or click [HERE](https://celehs.github.io/PETLER/reference/petler.fpca.html) to customize configurable arguments.

```{r fpca, eval=F}
system.time(obj <- petler.fpca(data_org))
saveRDS(obj, "step1.rds")
```

```{r, echo=F}
obj <- readRDS("step1.rds")
```

```{r}
DF.long <- rbind(
  cbind(code = "pred1", obj$base[[1]]$mean),
  cbind(code = "pred2", obj$base[[2]]$mean),
  cbind(code = "pred3", obj$base[[3]]$mean))
data.table::data.table(DF.long)
```

```{r}
TrainCode <- data_org$TrainCode
TrainCode[, monthstd := month / fu_time]  
DF.t <- rbind(
  data.frame(code = "pred1", t = with(TrainCode, rep(monthstd, pred1))),
  data.frame(code = "pred2", t = with(TrainCode, rep(monthstd, pred2))),
  data.frame(code = "pred3", t = with(TrainCode, rep(monthstd, pred3))))
```

```{r, fig.width=7, fig.height=7}
library(ggplot2)
ggplot(DF.t, aes(x = t)) + 
  geom_histogram(aes(y = ..density..), color="black", fill="white", binwidth = 0.01) + 
  geom_line(aes(x = x, y = f_mu), data = DF.long, colour = "blue") + 
  facet_wrap(~ code, ncol = 1, scales = "free_y") + 
  xlab("x") + theme_bw()
```

