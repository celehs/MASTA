---
title: "Step II. Model Estimation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
options(width=100)
```

In step II, we use the `petler.fit` function to fit penalized proportional odds (PO) models to the labeled time-to-event data with features derived in step I. When fitting the penalized PO models, the non-parametric baseline function is approximated using B-splines.

```{r lib}
library(PETLER)
```

```{r}
obj <- readRDS("step1.rds")
```

```{r, eval=FALSE}
system.time(fit <- petler.fit(obj))
##    user  system elapsed 
## 292.297   0.338 292.641
```

```{r, eval=FALSE, echo=FALSE}
saveRDS(fit, "step2.rds")
```

```{r, echo=FALSE}
fit <- readRDS("step2.rds")
```

```{r, include=FALSE}
bgbbest <- fit$bgbbest_FromChengInit_BFGS
colnames(bgbbest)[2] <- "MLE"
DF.wide <- data.frame(i = 1:nrow(bgbbest), bgbbest)
DF.wide
```

The output from the `petler.fit` function is a list with components: 

- details of the fitted model

- C-statistics and adjusted Brier scores of the derived algorithm

- A vector of consecutive integers describing the grouping coefficients

```{r, fig.width=8, fig.height=6, echo=FALSE}
library(ggplot2)
DF.long <- tidyr::gather(DF.wide, key = "type", value = "coef", bgbm.init:BIC.Orig)
ggplot(DF.long, aes(x = i, y = coef)) + 
  geom_bar(stat="identity") + 
  facet_wrap(~ type) + 
  theme_bw() + xlab("") + ylab("") 
```

```{r}
fit
```
